{"version":3,"sources":["../../src/components/monitorable.js"],"names":["axon","require","module","exports","Base","discovery","on","obj","adv","advertisement","type","key","startsWith","onMonitorAdded","monitorStatusPublisher","PubEmitterSocket","sock","set","statusInterval","discoveryOptions","monitorInterval","setInterval","onMonitorInterval","address","constructor","useHostNames","hostName","connect","port","socks","length","nodes","map","s","id","node","_host","remoteAddress","remotePort","emit","me"],"mappings":";;;;;;;;;;;;AAAA,IAAMA,OAAOC,QAAQ,gBAAR,CAAb;;AAEAC,OAAOC,OAAP,GAAiB,UAACC,IAAD;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA,6CACI;AAAA;;AACb;;AAEA,qBAAKC,SAAL,CAAeC,EAAf,CAAkB,OAAlB,EAA2B,UAACC,GAAD,EAAS;AAChC,wBAAMC,MAAMD,IAAIE,aAAhB;;AAEA,wBAAID,IAAIE,IAAJ,IAAY,SAAZ,IAAyB,CAAC,OAAKD,aAAL,CAAmBE,GAAnB,CAAuBC,UAAvB,CAAkCJ,IAAIG,GAAtC,CAA9B,EACI;;AAEJ,2BAAKE,cAAL,CAAoBN,GAApB;AACH,iBAPD;AAQH;AAZY;AAAA;AAAA,2CAcEA,GAdF,EAcO;AAAA;;AAChB,oBAAI,CAAC,KAAKO,sBAAV,EAAkC;AAC9B,yBAAKA,sBAAL,GAA8B,IAAId,KAAKe,gBAAT,EAA9B;AACA,yBAAKD,sBAAL,CAA4BE,IAA5B,CAAiCC,GAAjC,CAAqC,eAArC,EAAsD,CAAtD;AACA,wBAAMC,iBAAiB,KAAKC,gBAAL,CAAsBD,cAAtB,IAAwC,IAA/D;;AAEA,yBAAKE,eAAL,GAAuBC,YAAY;AAAA,+BAAM,OAAKC,iBAAL,EAAN;AAAA,qBAAZ,EAA4CJ,cAA5C,CAAvB;AACH;;AAED,oBAAIK,UAAUhB,IAAIgB,OAAlB;AACA,oBAAI,KAAKC,WAAL,CAAiBC,YAArB,EAAmCF,UAAUhB,IAAImB,QAAd;;AAEnC,qBAAKZ,sBAAL,CAA4Ba,OAA5B,CAAoCpB,IAAIE,aAAJ,CAAkBmB,IAAtD,EAA4DL,OAA5D;AACH;AA3BY;AAAA;AAAA,gDA6BO;AAAA;;AAChB,oBAAI,CAAC,KAAKT,sBAAL,CAA4BE,IAA5B,CAAiCa,KAAjC,CAAuCC,MAA5C,EAAoD;;AAEpD,oBAAMC,QAAQ,CAAC,KAAKf,IAAL,CAAUa,KAAV,IAAmB,KAAKb,IAAL,CAAUA,IAAV,CAAea,KAAnC,EAA0CG,GAA1C,CAA8C,UAACC,CAAD,EAAO;AAC/D,wBAAIA,EAAEC,EAAN,EAAU,OAAOD,EAAEC,EAAT;;AAEV,yBAAK,IAAIA,EAAT,IAAe,OAAK7B,SAAL,CAAe0B,KAA9B,EAAqC;AACjC,4BAAMI,OAAO,OAAK9B,SAAL,CAAe0B,KAAf,CAAqBG,EAArB,CAAb;;AAEA,4BAAI,CAAC,OAAKV,WAAL,CAAiBC,YAAjB,GAAgCQ,EAAEG,KAAF,IAAWD,KAAKT,QAAhD,GAA2DO,EAAEI,aAAF,IAAmBF,KAAKZ,OAApF,KACAU,EAAEK,UAAF,IAAgBH,KAAK1B,aAAL,CAAmBmB,IADvC,EAC6C;AACzCK,8BAAEC,EAAF,GAAOC,KAAKD,EAAZ;;AAEA,mCAAOD,EAAEC,EAAT;AACH;AACJ;AACJ,iBAba,CAAd;;AAeA,qBAAKpB,sBAAL,CAA4ByB,IAA5B,CAAiC,QAAjC,EAA2C;AACvCL,wBAAI,KAAK7B,SAAL,CAAemC,EAAf,CAAkBN,EADiB;AAEvCH,2BAAOA;AAFgC,iBAA3C;AAIH;AAnDY;;AAAA;AAAA,MAAoC3B,IAApC;AAAA,CAAjB","file":"monitorable.js","sourcesContent":["const axon = require('@dashersw/axon');\n\nmodule.exports = (Base) => class Monitorable extends Base {\n    startDiscovery() {\n        super.startDiscovery();\n\n        this.discovery.on('added', (obj) => {\n            const adv = obj.advertisement;\n\n            if (adv.type != 'monitor' || !this.advertisement.key.startsWith(adv.key))\n                return;\n\n            this.onMonitorAdded(obj);\n        });\n    }\n\n    onMonitorAdded(obj) {\n        if (!this.monitorStatusPublisher) {\n            this.monitorStatusPublisher = new axon.PubEmitterSocket();\n            this.monitorStatusPublisher.sock.set('retry timeout', 0);\n            const statusInterval = this.discoveryOptions.statusInterval || 5000;\n\n            this.monitorInterval = setInterval(() => this.onMonitorInterval(), statusInterval);\n        }\n\n        let address = obj.address;\n        if (this.constructor.useHostNames) address = obj.hostName;\n\n        this.monitorStatusPublisher.connect(obj.advertisement.port, address);\n    }\n\n    onMonitorInterval() {\n        if (!this.monitorStatusPublisher.sock.socks.length) return;\n\n        const nodes = (this.sock.socks || this.sock.sock.socks).map((s) => {\n            if (s.id) return s.id;\n\n            for (let id in this.discovery.nodes) {\n                const node = this.discovery.nodes[id];\n\n                if ((this.constructor.useHostNames ? s._host == node.hostName : s.remoteAddress == node.address) &&\n                    s.remotePort == node.advertisement.port) {\n                    s.id = node.id;\n\n                    return s.id;\n                }\n            }\n        });\n\n        this.monitorStatusPublisher.emit('status', {\n            id: this.discovery.me.id,\n            nodes: nodes,\n        });\n    }\n};\n"]}